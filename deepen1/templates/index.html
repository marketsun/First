<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²€ìƒ‰ í¬ë¡¤ëŸ¬</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-content">
            <h1 class="logo">ğŸ” ê²€ìƒ‰ í¬ë¡¤ëŸ¬</h1>
            <a href="/history" class="history-link">ê²€ìƒ‰ ê¸°ë¡</a>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <!-- ê²€ìƒ‰ ì˜ì—­ -->
        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    id="search-keyword" 
                    class="search-input" 
                    placeholder="ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    onkeypress="if(event.key === 'Enter') handleSearch()"
                >
                <button id="search-btn" class="search-button" onclick="handleSearch()">
                    ê²€ìƒ‰
                </button>
            </div>
            
            <!-- ì§„í–‰ ìƒíƒœ -->
            <div id="progress-container" class="progress-container" style="display: none;">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill">0%</div>
                </div>
                <div id="status-message" class="status-message">ì¤€ë¹„ ì¤‘...</div>
            </div>
        </div>

        <!-- í•„í„° ì˜ì—­ (ê²°ê³¼ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
        <div id="filter-section" class="filter-section" style="display: none;">
            <div class="filter-container">
                <div class="filter-item">
                    <input type="text" id="filter-keyword" class="filter-input" placeholder="í‚¤ì›Œë“œ í•„í„°">
                </div>
                <div class="filter-item">
                    <input type="date" id="filter-date-from" class="filter-input">
                </div>
                <div class="filter-item">
                    <input type="date" id="filter-date-to" class="filter-input">
                </div>
                <div class="filter-item">
                    <select id="filter-sort" class="filter-input">
                        <option value="">ê¸°ë³¸ ìˆœì„œ</option>
                        <option value="view_desc">ì¡°íšŒìˆ˜ ë†’ì€ìˆœ</option>
                        <option value="view_asc">ì¡°íšŒìˆ˜ ë‚®ì€ìˆœ</option>
                        <option value="date_desc">ìµœì‹ ìˆœ</option>
                        <option value="date_asc">ì˜¤ë˜ëœìˆœ</option>
                    </select>
                </div>
                <button class="filter-btn" onclick="applyFilters()">ì ìš©</button>
                <button class="filter-btn-reset" onclick="resetFilters()">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ (2ë¶„í• ) -->
        <div id="results-container" class="results-container">
            <!-- êµ¬ê¸€ ê²°ê³¼ (ì™¼ìª½) -->
            <div class="results-column">
                <div class="column-header">
                    <h2 class="column-title">ğŸŒ êµ¬ê¸€</h2>
                    <span class="result-count"><span id="google-count">0</span>ê°œ</span>
                </div>
                <div id="google-results" class="results-list">
                    <div class="result-table">
                        <div class="result-table-header">
                            <div class="result-table-cell source-cell">ì¶œì²˜</div>
                            <div class="result-table-cell title-cell">ì œëª©</div>
                        </div>
                        <div class="empty-state">ê²€ìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>

            <!-- ìœ íŠœë¸Œ ê²°ê³¼ (ì˜¤ë¥¸ìª½) -->
            <div class="results-column">
                <div class="column-header">
                    <h2 class="column-title">ğŸ¥ ìœ íŠœë¸Œ</h2>
                    <span class="result-count"><span id="youtube-count">0</span>ê°œ</span>
                </div>
                <div id="youtube-results" class="results-list">
                    <div class="result-table">
                        <div class="result-table-header">
                            <div class="result-table-cell" style="width: 60px;">ìˆœì„œ</div>
                            <div class="result-table-cell" style="width: 100px;">íƒ€ì…</div>
                            <div class="result-table-cell channel-cell">ì±„ë„ëª…</div>
                            <div class="result-table-cell date-cell sortable" onclick="toggleYoutubeSort('date')">
                                ì—…ë¡œë“œì¼ <span class="sort-icon active">â†“</span><span class="sort-icon">â†‘</span>
                            </div>
                            <div class="result-table-cell views-cell sortable" onclick="toggleYoutubeSort('views')">
                                ì¡°íšŒìˆ˜ <span class="sort-icon">â†“</span><span class="sort-icon">â†‘</span>
                            </div>
                            <div class="result-table-cell title-cell">ì œëª©</div>
                        </div>
                        <div class="empty-state">ê²€ìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œê·¸ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨ ê³ ì •) -->
    <button class="log-button" onclick="toggleLogModal()" title="í¬ë¡¤ë§ ë¡œê·¸">
        ğŸ“‹
    </button>

    <!-- ë¡œê·¸ í”Œë¡œíŒ… ì°½ -->
    <div id="log-modal" class="log-modal">
        <div class="log-header">
            <div class="log-title">
                <span>ğŸ“‹</span>
                <span>í¬ë¡¤ë§ ë¡œê·¸</span>
            </div>
            <div class="log-actions">
                <button class="log-action-btn log-copy-btn" onclick="copyLogs(event)">ì „ì²´ ë³µì‚¬</button>
                <button class="log-action-btn log-close-btn" onclick="toggleLogModal()">ë‹«ê¸°</button>
            </div>
        </div>
        <div id="log-content" class="log-content">
            <div class="log-empty">
                <div class="log-empty-icon">ğŸ“‹</div>
                <div>ì•„ì§ í¬ë¡¤ë§ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        let currentSearchId = null;
        let currentCrawlId = null;

        async function handleSearch() {
            const keyword = document.getElementById('search-keyword').value.trim();
            
            if (!keyword) {
                showAlert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // í•„í„° ìˆ¨ê¸°ê¸°
            document.getElementById('filter-section').style.display = 'none';
            
            // í¬ë¡¤ë§ ì‹œì‘
            await performSearch(keyword);
        }

        // performSearch í•¨ìˆ˜ ì˜¤ë²„ë¼ì´ë“œ
        async function performSearch(keyword) {
            const searchBtn = document.getElementById('search-btn');
            const googleResults = document.getElementById('google-results');
            const youtubeResults = document.getElementById('youtube-results');
            
            // ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”
            searchBtn.disabled = true;
            
            // ê° ê²°ê³¼ì°½ì— ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
            googleResults.innerHTML = `
                <div class="result-table">
                    <div class="result-table-header">
                        <div class="result-table-cell source-cell">ì¶œì²˜</div>
                        <div class="result-table-cell title-cell">ì œëª©</div>
                    </div>
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ê²€ìƒ‰ ì¤‘...</p>
                    </div>
                </div>
            `;
            
            youtubeResults.innerHTML = `
                <div class="result-table">
                    <div class="result-table-header">
                        <div class="result-table-cell" style="width: 60px;">ìˆœì„œ</div>
                        <div class="result-table-cell" style="width: 100px;">íƒ€ì…</div>
                        <div class="result-table-cell channel-cell">ì±„ë„ëª…</div>
                        <div class="result-table-cell date-cell sortable" onclick="toggleYoutubeSort('date')">
                            ì—…ë¡œë“œì¼ <span class="sort-icon active">â†“</span><span class="sort-icon">â†‘</span>
                        </div>
                        <div class="result-table-cell views-cell sortable" onclick="toggleYoutubeSort('views')">
                            ì¡°íšŒìˆ˜ <span class="sort-icon">â†“</span><span class="sort-icon">â†‘</span>
                        </div>
                        <div class="result-table-cell title-cell">ì œëª©</div>
                    </div>
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ê²€ìƒ‰ ì¤‘...</p>
                    </div>
                </div>
            `;
            
            try {
                // ê²€ìƒ‰ ìš”ì²­
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
                const crawlId = data.crawl_id;
                currentCrawlId = crawlId;
                
                // ë¡œê·¸ ì—…ë°ì´íŠ¸ ì‹œì‘
                startLogUpdates(crawlId);
                
                // ì§„í–‰ ìƒíƒœ í™•ì¸
                const checkStatus = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`/crawl-status/${crawlId}`);
                        const statusData = await statusResponse.json();
                        
                        console.log('[DEBUG] ìƒíƒœ í™•ì¸:', statusData);
                        
                        if (statusData.status === 'completed') {
                            console.log('[ì„±ê³µ] í¬ë¡¤ë§ ì™„ë£Œ ê°ì§€!');
                            console.log('[DEBUG] search_id:', statusData.search_id);
                            
                            clearInterval(checkStatus);
                            
                            // ë¡œê·¸ ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
                            if (logUpdateInterval) {
                                clearInterval(logUpdateInterval);
                                logUpdateInterval = null;
                            }
                            
                            showAlert('ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                            
                            // ê²°ê³¼ í‘œì‹œ
                            currentSearchId = statusData.search_id;
                            console.log('[DEBUG] loadResults í˜¸ì¶œ ì‹œì‘...');
                            await loadResults(statusData.search_id);
                            console.log('[DEBUG] loadResults ì™„ë£Œ!');
                            
                            searchBtn.disabled = false;
                            
                        } else if (statusData.status === 'error') {
                            clearInterval(checkStatus);
                            
                            // ë¡œê·¸ ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
                            if (logUpdateInterval) {
                                clearInterval(logUpdateInterval);
                                logUpdateInterval = null;
                            }
                            
                            showAlert(statusData.error || 'í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                            searchBtn.disabled = false;
                        }
                        
                    } catch (error) {
                        console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                    }
                }, 1000);
                
            } catch (error) {
                showAlert(error.message, 'error');
                searchBtn.disabled = false;
            }
        }

        // ê°™ì€ í˜ì´ì§€ì— ê²°ê³¼ ë¡œë“œ
        async function loadResultsInline(searchId, filters = {}) {
            console.log('[DEBUG] loadResultsInline ì‹œì‘, searchId:', searchId);
            
            const googleResults = document.getElementById('google-results');
            const youtubeResults = document.getElementById('youtube-results');
            const googleCount = document.getElementById('google-count');
            const youtubeCount = document.getElementById('youtube-count');
            const resultsContainer = document.getElementById('results-container');
            const filterSection = document.getElementById('filter-section');
            
            // í•„í„° ì˜ì—­ í‘œì‹œ
            filterSection.style.display = 'block';
            
            // ë¡œë”© í‘œì‹œ
            googleResults.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>';
            youtubeResults.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>';
            
            try {
                // í•„í„° íŒŒë¼ë¯¸í„° ìƒì„±
                const params = new URLSearchParams(filters);
                
                const apiUrl = `/api/results/${searchId}?${params}`;
                console.log('[DEBUG] API í˜¸ì¶œ:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('[DEBUG] API ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('[DEBUG] API ì‘ë‹µ ë°ì´í„°:', data);
                console.log('[DEBUG] êµ¬ê¸€ ê²°ê³¼ ìˆ˜:', data.google_results?.length);
                console.log('[DEBUG] ìœ íŠœë¸Œ ê²°ê³¼ ìˆ˜:', data.youtube_results?.length);
                
                // êµ¬ê¸€ ê²°ê³¼ ë Œë”ë§
                if (data.google_results.length > 0) {
                    googleResults.innerHTML = data.google_results.map(result => `
                        <div class="result-card">
                            ${result.thumbnail ? `
                                <div class="result-thumbnail">
                                    <img src="${result.thumbnail}" alt="${result.title}" onerror="this.parentElement.style.display='none'">
                                </div>
                            ` : ''}
                            <div class="result-content">
                                <h3 class="result-title">
                                    <a href="${result.url}" target="_blank">${result.title}</a>
                                </h3>
                                <p class="result-url">${result.url}</p>
                                ${result.snippet ? `<p class="result-snippet">${result.snippet}</p>` : ''}
                                <div class="result-meta">
                                    <span class="meta-badge">ìˆœìœ„ ${result.position}</span>
                                    ${result.published_date ? `<span class="meta-badge">${result.published_date}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    googleCount.textContent = data.google_results.length;
                } else {
                    googleResults.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    googleCount.textContent = '0';
                }
                
                // ìœ íŠœë¸Œ ê²°ê³¼ ë Œë”ë§
                if (data.youtube_results.length > 0) {
                    youtubeResults.innerHTML = data.youtube_results.map(result => `
                        <div class="result-card">
                            ${result.thumbnail ? `
                                <div class="result-thumbnail">
                                    <img src="${result.thumbnail}" alt="${result.title}">
                                </div>
                            ` : ''}
                            <div class="result-content">
                                <h3 class="result-title">
                                    <a href="${result.url}" target="_blank">${result.title}</a>
                                </h3>
                                <p class="result-url">${result.url}</p>
                                <div class="result-meta">
                                    ${result.channel_name ? `<span class="meta-badge">ğŸ‘¤ ${result.channel_name}</span>` : ''}
                                    ${result.view_count ? `<span class="meta-badge">ğŸ‘ï¸ ${result.view_count}</span>` : ''}
                                    ${result.upload_date ? `<span class="meta-badge">ğŸ“… ${result.upload_date}</span>` : ''}
                                    <span class="meta-badge">ìˆœìœ„ ${result.position}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    youtubeCount.textContent = data.youtube_results.length;
                } else {
                    youtubeResults.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    youtubeCount.textContent = '0';
                }
                
                // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                console.log('[DEBUG] ê²°ê³¼ ë Œë”ë§ ì™„ë£Œ, ìŠ¤í¬ë¡¤ ì´ë™');
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                console.error('[ì˜¤ë¥˜] ê²°ê³¼ ë¡œë“œ ì˜¤ë¥˜:', error);
                console.error('[ì˜¤ë¥˜] ìƒì„¸:', error.stack);
                showAlert('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                
                // ì˜¤ë¥˜ ì‹œ ë¹ˆ ìƒíƒœ í‘œì‹œ
                googleResults.innerHTML = '<div class="empty-state">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
                youtubeResults.innerHTML = '<div class="empty-state">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            if (!currentSearchId) return;
            
            const filters = {
                keyword: document.getElementById('filter-keyword').value || '',
                date_from: document.getElementById('filter-date-from').value || '',
                date_to: document.getElementById('filter-date-to').value || '',
                sort_by: document.getElementById('filter-sort').value || ''
            };
            
            loadResultsInline(currentSearchId, filters);
        }

        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            if (!currentSearchId) return;
            
            document.getElementById('filter-keyword').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-sort').value = '';
            
            loadResultsInline(currentSearchId);
        }

        // ë¡œê·¸ ëª¨ë‹¬ í† ê¸€
        function toggleLogModal() {
            const modal = document.getElementById('log-modal');
            modal.classList.toggle('show');
        }

        // ESC í‚¤ë¡œ ë¡œê·¸ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('log-modal');
                if (modal.classList.contains('show')) {
                    modal.classList.remove('show');
                }
            }
        });

        // ë¡œê·¸ ì—…ë°ì´íŠ¸
        let logUpdateInterval = null;
        
        function startLogUpdates(crawlId) {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            if (logUpdateInterval) {
                clearInterval(logUpdateInterval);
            }
            
            console.log('[ë¡œê·¸ ì—…ë°ì´íŠ¸] ì‹œì‘:', crawlId);
            
            // ë¡œê·¸ ì—…ë°ì´íŠ¸ ì‹œì‘
            logUpdateInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/logs/${crawlId}`);
                    const data = await response.json();
                    
                    console.log('[ë¡œê·¸ ì—…ë°ì´íŠ¸] ë°›ì€ ë¡œê·¸ ê°œìˆ˜:', data.logs ? data.logs.length : 0);
                    
                    const logContent = document.getElementById('log-content');
                    
                    if (data.logs && data.logs.length > 0) {
                        // HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                        const escapeHtml = (text) => {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };
                        
                        logContent.innerHTML = data.logs.map((log, index) => {
                            let className = 'log-line';
                            if (log.includes('ì™„ë£Œ') || log.includes('ì„±ê³µ')) {
                                className += ' success';
                            } else if (log.includes('ì˜¤ë¥˜') || log.includes('ì‹¤íŒ¨') || log.includes('Error')) {
                                className += ' error';
                            } else if (log.includes('ì‹œì‘') || log.includes('ì¤‘...')) {
                                className += ' info';
                            }
                            return `<div class="${className}" data-index="${index}">${escapeHtml(log)}</div>`;
                        }).join('');
                        
                        // ìë™ ìŠ¤í¬ë¡¤ (ìµœì‹  ë¡œê·¸ê°€ ë³´ì´ë„ë¡)
                        logContent.scrollTop = logContent.scrollHeight;
                    } else {
                        console.log('[ë¡œê·¸ ì—…ë°ì´íŠ¸] ë¡œê·¸ê°€ ë¹„ì–´ìˆìŒ');
                    }
                } catch (error) {
                    console.error('ë¡œê·¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                }
            }, 1000);
        }

        // ë¡œê·¸ ì „ì²´ ë³µì‚¬
        async function copyLogs(event) {
            const btn = event ? event.target : document.querySelector('.log-copy-btn');
            
            if (!currentCrawlId) {
                showAlert('ë³µì‚¬í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/logs/${currentCrawlId}`);
                const data = await response.json();
                
                if (data.logs && data.logs.length > 0) {
                    const logText = data.logs.join('\n');
                    await navigator.clipboard.writeText(logText);
                    
                    // ë³µì‚¬ ì™„ë£Œ í”¼ë“œë°±
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ“ ë³µì‚¬ ì™„ë£Œ!';
                    btn.style.background = '#00C853';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                    
                    showAlert(`${data.logs.length}ê°œì˜ ë¡œê·¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    showAlert('ë³µì‚¬í•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('ë³µì‚¬ ì˜¤ë¥˜:', error);
                showAlert('ë¡œê·¸ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
